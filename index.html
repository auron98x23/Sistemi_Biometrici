<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quiz Master Pro</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="reveal-mode">

<div class="container">
    <div class="header-top">
        <h1>AI Quiz Master <span id="quiz-range-label">(Caricamento...)</span></h1>
        <button class="theme-toggle" onclick="toggleTheme()">
            <span id="theme-icon">‚òÄÔ∏è</span>
        </button>
    </div>

    <div id="auth-container" class="auth-box">
        <div id="login-form" class="login-row">
            <input type="text" id="username-input" placeholder="Username">
            <input type="password" id="password-input" placeholder="Password">
            <button id="btn-login" class="btn-action btn-login">Accedi</button>
            <button id="btn-register" class="btn-action btn-reg">Registrati</button>
        </div>
        <div id="user-info" class="user-row" style="display:none;">
            <span>Ciao, <b id="user-display-name"></b></span>
            <button id="btn-logout" class="btn-action btn-logout">Esci</button>
        </div>
    </div>

    <div class="score-box">
        <div class="stat">Punti: <span id="score">0</span></div>
        <div class="stat">Errori: <span id="errors">0</span></div>
        <div class="stat">Voto: <span id="grade">0.0</span>/30</div>
    </div>

    <div class="controls-grid">
        <div class="control-group">
            <label>Blocchi Domande:</label>
            <div id="filter-container" class="filter-chips"></div>
        </div>
        <div class="control-group">
            <label>Ordine Domande:</label>
            <select id="mode-q"><option value="ordered">Sequenziale</option><option value="random">Casuale</option></select>
        </div>
        <div class="control-group">
            <label>Modalit√† Cloud:</label>
            <button id="btn-cloud-toggle" class="btn-cloud">Solo Errori Cloud: OFF</button>
        </div>
    </div>

    <div id="error-panel" class="error-panel" style="display:none;">
        <p>Domande errate:</p>
        <div id="error-list"></div>
    </div>

    <div id="quiz-container"></div>
    <button id="btn-back-to-top">‚Üë</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA7tsfHv64JlJRB7rrWHgmT786f-jwcU-c",
        authDomain: "testdomande-e5950.firebaseapp.com",
        projectId: "testdomande-e5950",
        storageBucket: "testdomande-e5950.firebasestorage.app",
        messagingSenderId: "66125293330",
        appId: "1:66125293330:web:cb1133f852ba4fa5f575cb"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let fullDb = [], activeBlocks = [1], currentQuizSet = [];
    let score = 0, errors = 0, currentUser = null;
    let cloudErrorIds = [], isCloudMode = false, currentSelections = {};

    // --- Caricamento Dati ---
    async function loadQuestions() {
        try {
            const res = await fetch('questions.json');
            const data = await res.json();
            fullDb = Object.keys(data).map(id => ({
                id: parseInt(id),
                q: data[id].domanda,
                options: data[id].risposte,
                correct: Array.isArray(data[id].giusta) ? data[id].giusta : [] 
            })).sort((a,b) => a.id - b.id);
            
            setupFilters();
            regenerateQuiz();
        } catch (e) {
            document.getElementById('quiz-container').innerHTML = `<div class="error">Errore critico: Il file JSON non √® nel formato corretto [Indici numerici richiesti].</div>`;
        }
    }

    function setupFilters() {
        const container = document.getElementById('filter-container');
        const total = fullDb.length;
        const numBlocks = Math.ceil(total / 50);
        container.innerHTML = '';
        for(let i=1; i<=numBlocks; i++) {
            const btn = document.createElement('button');
            btn.innerText = `B${i}`;
            btn.className = activeBlocks.includes(i) ? 'chip active' : 'chip';
            btn.onclick = () => {
                activeBlocks.includes(i) ? activeBlocks = activeBlocks.filter(b => b!==i) : activeBlocks.push(i);
                setupFilters();
                regenerateQuiz();
            };
            container.appendChild(btn);
        }
    }

    function regenerateQuiz() {
        const container = document.getElementById('quiz-container');
        container.innerHTML = '';
        currentSelections = {};
        
        // Filtro blocchi o Cloud
        let filtered = isCloudMode 
            ? fullDb.filter(q => cloudErrorIds.includes(q.id))
            : fullDb.filter(q => activeBlocks.includes(Math.ceil(q.id / 50)));

        if(document.getElementById('mode-q').value === 'random') {
            filtered.sort(() => Math.random() - 0.5);
        }

        currentQuizSet = filtered;
        filtered.forEach(renderQuestion);
        updateStats();
    }

    function renderQuestion(q) {
        const div = document.createElement('div');
        div.className = 'question-card';
        div.id = `q-${q.id}`;
        div.innerHTML = `
            <div class="q-header">Domanda ${q.id}</div>
            <div class="q-text">${q.q}</div>
            <div class="options-list">
                ${q.options.map((opt, i) => `
                    <div class="option-label" onclick="window.checkAns(${q.id}, ${i}, ${JSON.stringify(q.correct)}, this)">
                        ${opt}
                    </div>
                `).join('')}
            </div>
        `;
        document.getElementById('quiz-container').appendChild(div);
    }

    window.checkAns = async (qId, selIndex, correctIndices, el) => {
        const parent = el.parentElement;
        if(parent.classList.contains('answered')) return;

        if(!currentSelections[qId]) currentSelections[qId] = [];

        if(correctIndices.includes(selIndex)) {
            if(!currentSelections[qId].includes(selIndex)) {
                el.classList.add('correct');
                currentSelections[qId].push(selIndex);
                if(currentSelections[qId].length === correctIndices.length) {
                    parent.classList.add('answered');
                    score++;
                    updateStats();
                }
            }
        } else {
            el.classList.add('wrong');
            parent.classList.add('answered');
            errors++;
            correctIndices.forEach(idx => parent.children[idx].classList.add('correct'));
            if(currentUser) addErrorToCloud(qId);
            updateStats();
        }
    };

    async function addErrorToCloud(qId) {
        const userRef = doc(db, "users", currentUser.uid);
        await updateDoc(userRef, {
            errorIds: arrayUnion(qId),
            [`errorCounts.${qId}`]: increment(1)
        }).catch(() => setDoc(userRef, { errorIds: [qId], errorCounts: { [qId]: 1 } }));
    }

    function updateStats() {
        document.getElementById('score').innerText = score;
        document.getElementById('errors').innerText = errors;
        const total = currentQuizSet.length || 1;
        document.getElementById('grade').innerText = ((score/total)*30).toFixed(1);
    }

    // --- Auth Logic ---
    onAuthStateChanged(auth, async (user) => {
        if(user) {
            currentUser = user;
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('user-display-name').innerText = user.email.split('@')[0];
            const snap = await getDoc(doc(db, "users", user.uid));
            if(snap.exists()) cloudErrorIds = snap.data().errorIds || [];
        } else {
            currentUser = null;
            document.getElementById('login-form').style.display = 'flex';
            document.getElementById('user-info').style.display = 'none';
        }
    });

    document.getElementById('btn-login').onclick = () => {
        const email = document.getElementById('username-input').value + "@quiz.app";
        const pass = document.getElementById('password-input').value;
        signInWithEmailAndPassword(auth, email, pass);
    };

    document.getElementById('btn-register').onclick = () => {
        const email = document.getElementById('username-input').value + "@quiz.app";
        const pass = document.getElementById('password-input').value;
        createUserWithEmailAndPassword(auth, email, pass);
    };

    document.getElementById('btn-logout').onclick = () => signOut(auth);

    document.getElementById('btn-cloud-toggle').onclick = (e) => {
        isCloudMode = !isCloudMode;
        e.target.innerText = `Solo Errori Cloud: ${isCloudMode ? 'ON' : 'OFF'}`;
        e.target.style.background = isCloudMode ? '#ff4444' : '#444';
        regenerateQuiz();
    };

    window.toggleTheme = () => {
        const body = document.body;
        if(body.getAttribute('data-theme') === 'dark') {
            body.removeAttribute('data-theme');
            document.getElementById('theme-icon').innerText = '‚òÄÔ∏è';
        } else {
            body.setAttribute('data-theme', 'dark');
            document.getElementById('theme-icon').innerText = 'üåô';
        }
    };

    loadQuestions();
</script>
</body>
</html>
